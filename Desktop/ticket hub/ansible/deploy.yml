---
- name: Deploy Ticket Booking Application
  hosts: all
  become: yes
  vars:
    docker_image_backend: "your-dockerhub-username/ticket-booking-backend:latest"
    docker_image_frontend: "your-dockerhub-username/ticket-booking-frontend:latest"
  tasks:
    - name: Pull latest Docker images
      docker_image:
        name: "{{ item }}"
        source: pull
      loop:
        - "{{ docker_image_backend }}"
        - "{{ docker_image_frontend }}"

    - name: Stop existing containers
      docker_container:
        name: "{{ item }}"
        state: stopped
      loop:
        - ticket-backend
        - ticket-frontend
      ignore_errors: yes

    - name: Remove old containers
      docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - ticket-backend
        - ticket-frontend
      ignore_errors: yes

    - name: Start backend container
      docker_container:
        name: ticket-backend
        image: "{{ docker_image_backend }}"
        state: started
        restart_policy: always
        ports:
          - "8081:8081"
        env:
          SPRING_PROFILES_ACTIVE: "prod"
          DB_URL: "jdbc:postgresql://postgres:5432/ticketbooking"
          DB_USERNAME: "postgres"
          DB_PASSWORD: "{{ db_password }}"
          JWT_SECRET: "{{ jwt_secret }}"
        networks:
          - name: ticket-network

    - name: Start frontend container
      docker_container:
        name: ticket-frontend
        image: "{{ docker_image_frontend }}"
        state: started
        restart_policy: always
        ports:
          - "80:80"
        networks:
          - name: ticket-network

    - name: Wait for backend to be healthy
      uri:
        url: http://localhost:8081/actuator/health
        method: GET
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10
      ignore_errors: yes

